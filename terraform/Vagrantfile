# -*- mode: ruby -*-
# vi: set ft=ruby :
ENV['VAGRANT_DEFAULT_PROVIDER'] = 'vmware_fusion'

Vagrant.configure('2') do |config|
  # Base box
  config.vm.box      = 'generic/ubuntu2204'
  config.vm.hostname = 'eks-image-builder'

  # Private network (DHCP)
  config.vm.network 'private_network', type: 'dhcp'

  # VMware Fusion provider tweaks
  config.vm.provider :vmware_fusion do |v|
    v.gui = false
    # Enable VT-x/AMD-V passthrough (nested virt)
    v.vmx['vhv.enable'] = 'TRUE'
  end

  # ─── Validation ────────────────────────────────────────────────────────────────
  config.vm.provision 'shell', privileged: true, inline: <<-'SHELL'
    echo '=== VALIDATION ==='
    if grep -Eq '(vmx|svm)' /proc/cpuinfo; then
      echo 'Hardware virtualization flags detected (vmx/svm) ✔'
    else
      echo 'WARNING: Nested virtualization NOT available.'
    fi
    echo 'Provisioning complete.'
  SHELL
end